{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "_generator": {
            "name": "bicep",
            "version": "0.5.6.12127",
            "templateHash": "12705365244308198684"
        }
    },
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources."
            }
        },
        "vnet-name": {
            "type": "string",
            "defaultValue": "aks_vnet",
            "metadata": {
                "description": "Virtual Network Name"
            }
        },
        "vnetAddressPrefix": {
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description": "Virtual Network Address Prefix"
            }
        },
        "aks-subnet": {
            "type": "string",
            "defaultValue": "aks-subnet",
            "metadata": {
                "description": "AKS Subnet Name"
            }
        },
        "aks-subnetPrefix": {
            "type": "string",
            "defaultValue": "10.0.0.0/21",
            "metadata": {
                "description": "AKS Subnet Address Prefix"
            }
        },
        "postgresql_subnet": {
            "type": "string",
            "defaultValue": "postgresql_subnet",
            "metadata": {
                "description": "PostgreSQL Subnet Name"
            }
        },
        "postgresubnetPrefix": {
            "type": "string",
            "defaultValue": "10.0.8.0/24",
            "metadata": {
                "description": "Subnet Address Prefix"
            }
        },
        "ClusterName": {
            "defaultValue": "aks",
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the AKS cluster."
            }
        },
        "osDiskSizeGB": {
            "defaultValue": 100,
            "type": "int",
            "metadata": {
                "description": "Specifies the OS Disk Size in GB to be used to specify the disk size for every machine in this master/agent pool. If you specify 0, it will apply the default osDisk size according to the vmSize specified.."
            }
        },
        "agentCount": {
            "type": "int",
            "defaultValue": 1,
            "maxValue": 100,
            "minValue": 1,
            "metadata": {
                "description": "The number of nodes for the cluster. 1 Node is enough for Dev/Test and minimum 3 nodes, is recommended for Production"
            }
        },
        "agentVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "The size of the Virtual Machine."
            }
        },
        "aksClusterEnablePrivateCluster": {
            "defaultValue": true,
            "type": "bool",
            "metadata": {
                "description": "Specifies whether to create the cluster as a private cluster or not."
            }
        },

        "dnsPrefix": {
            "defaultValue": "[parameters('ClusterName')]",
            "type": "string",
            "metadata": {
                "description": "Specifies the DNS prefix specified when creating the managed cluster."
            }
        },
        "aksClusterSkuTier": {
            "type": "string",
            "defaultValue": "Paid",
            "allowedValues": [
                "Paid",
                "Free"
            ],
            "metadata": {
                "description": "Specifies the tier of a managed cluster SKU: Paid or Free"
            }
        },
        "serverName": {
            "type": "string",
            "metadata": {
                "description": "Server Name for Azure Database for PostgreSQL"
            }
        },
        "administratorLogin": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Database administrator login name"
            }
        },
        "administratorLoginPassword": {
            "type": "securestring",
            "minLength": 8,
            "metadata": {
                "description": "Database administrator password"
            }
        },
        "skuCapacity": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "Azure Database for PostgreSQL compute capacity in vCores (2,4,8,16,32)"
            }
        },
        "skuName": {
            "type": "string",
            "defaultValue": "GP_Gen5_2",
            "metadata": {
                "description": "Azure Database for PostgreSQL sku name "
            }
        },
        "skuSizeMB": {
            "type": "int",
            "defaultValue": 51200,
            "metadata": {
                "description": "Azure Database for PostgreSQL Sku Size "
            }
        },
        "skuTier": {
            "type": "string",
            "defaultValue": "GeneralPurpose",
            "allowedValues": [
                "Basic",
                "GeneralPurpose",
                "MemoryOptimized"
            ],
            "metadata": {
                "description": "Azure Database for PostgreSQL pricing tier"
            }
        },
        "skuFamily": {
            "type": "string",
            "defaultValue": "Gen5",
            "metadata": {
                "description": "Azure Database for PostgreSQL sku family"
            }
        },
        "postgresqlVersion": {
            "type": "string",
            "defaultValue": "11",
            "allowedValues": [
                "9.5",
                "9.6",
                "10",
                "10.0",
                "10.2",
                "11"
            ],
            "metadata": {
                "description": "PostgreSQL version"
            }
        },        
        "backupRetentionDays": {
            "type": "int",
            "defaultValue": 7,
            "metadata": {
                "description": "PostgreSQL Server backup retention days"
            }
        },
        "geoRedundantBackup": {
            "type": "string",
            "defaultValue": "Disabled",
            "metadata": {
                "description": "Geo-Redundant Backup setting"
            }
        }



    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2021-05-01",
            "name": "[parameters('vnet-name')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('vnetAddressPrefix')]"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2021-05-01",
            "name": "[format('{0}/{1}', parameters('vnet-name'), parameters('aks-subnet'))]",
            "properties": {
                "addressPrefix": "[parameters('aks-subnetPrefix')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnet-name'))]"
            ]
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2021-05-01",
            "name": "[format('{0}/{1}', parameters('vnet-name'), parameters('postgresql_subnet'))]",
            "properties": {
                "addressPrefix": "[parameters('postgresubnetPrefix')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnet-name'))]"
            ]
        },
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2022-05-02-preview",
            "name": "[parameters('clusterName')]",
            "location": "[parameters('location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "dnsPrefix": "[parameters('dnsPrefix')]",
                "sku": {
                    "name": "Basic",
                    "tier": "[parameters('aksClusterSkuTier')]"
                },
                "agentPoolProfiles": [
                    {
                        "name": "agentpool",
                        "osDiskSizeGB": "[parameters('osDiskSizeGB')]",
                        "count": "[parameters('agentCount')]",
                        "vmSize": "[parameters('agentVMSize')]",
                        "osType": "Linux",
                        "mode": "System"
                    }
                ],

                "apiServerAccessProfile": {
                    "enablePrivateCluster": "[parameters('aksClusterEnablePrivateCluster')]"
                }
            }
        },
        {
            "type": "Microsoft.DBforPostgreSQL/servers",
            "apiVersion": "2017-12-01",
            "name": "[parameters('serverName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]",
                "capacity": "[parameters('skuCapacity')]",
                "size": "[format('{0}', parameters('skuSizeMB'))]",
                "family": "[parameters('skuFamily')]"
            },
            "properties": {
                "createMode": "Default",
                "version": "[parameters('postgresqlVersion')]",
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "storageProfile": {
                    "storageMB": "[parameters('skuSizeMB')]",
                    "backupRetentionDays": "[parameters('backupRetentionDays')]",
                    "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                }
            }
        }
    ]
}
